name: Backend CI/CD

# KÃ­ch hoáº¡t workflow khi:
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'

# Äá»‹nh nghÄ©a cÃ¡c jobs
jobs:
  # Job 1: Kiá»ƒm thá»­ vÃ  Build
  test-and-build:
    name: Test & Build Backend
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      # BÆ°á»›c 1: Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # BÆ°á»›c 2: Setup Node.js
      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      # BÆ°á»›c 3: Install dependencies
      - name: ğŸ“¦ Install dependencies
        working-directory: ./backend
        run: npm ci
      
      # BÆ°á»›c 4: Lint code (náº¿u cÃ³ ESLint)
      - name: ğŸ” Lint code
        working-directory: ./backend
        run: |
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            npm run lint || echo "âš ï¸ No lint script found, skipping..."
          else
            echo "âš ï¸ No ESLint config found, skipping..."
          fi
        continue-on-error: true
      
      # BÆ°á»›c 5: Run tests (náº¿u cÃ³)
      - name: ğŸ§ª Run tests
        working-directory: ./backend
        run: |
          if grep -q "\"test\"" package.json; then
            npm test
          else
            echo "âš ï¸ No test script found, skipping..."
          fi
        continue-on-error: true
      
      # BÆ°á»›c 6: Build check (Ä‘áº£m báº£o code khÃ´ng cÃ³ lá»—i syntax)
      - name: ğŸ—ï¸ Build check
        working-directory: ./backend
        run: |
          echo "âœ… Checking if server.js can be loaded..."
          node -c server.js
          echo "âœ… Backend code syntax is valid!"

  # Job 2: Deploy to Render (chá»‰ cháº¡y khi push vÃ o main)
  deploy:
    name: Deploy to Render
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy to Render
        run: |
          echo "ğŸ¯ Triggering Render deployment..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "âœ… Deployment triggered successfully!"
